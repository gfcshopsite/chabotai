<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot con riconoscimento forme e testo</title>
    <link rel="stylesheet" href="styles.css">
    <script async src="https://docs.opencv.org/master/opencv.js"></script> <!-- OpenCV.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.1/dist/tesseract.min.js"></script> <!-- Tesseract.js -->
</head>
<body>
    <h1>
        <img src="https://cdn.discordapp.com/attachments/1134533272441983086/1296427111359316061/Screenshot_2024-10-17_125751-removebg-preview.png?ex=67123f55&is=6710edd5&hm=2a9333a05098c776d01ec5f120702968edf82330114558fa210670d0aeb9ee52" 
             alt="Logo" class="chatbot-logo">
        Chatbot
    </h1>
    <div id="chat-container"></div>
    <input type="text" id="user-input" placeholder="Scrivi un messaggio o un'operazione...">
    <button id="send-button">Invia</button>
    <input type="file" id="image-upload" accept="image/*">
    
 <!-- Aggiunta del nuovo bottone -->
 <button id="chatbot-link" onclick="window.location.href='https://www.hotbot.com/';">
    Vai al Chat Bot Alternative
</button>

 <!-- Aggiunta del nuovo bottone -->
 <button id="chatbot-link" onclick="window.location.href='https://math.bot/it/app/3e64fe1f522de132af39e1d9da526a5f';">
    MATH CHAT BOT AI
</button>

 <!-- Aggiunta del nuovo bottone -->
 <button id="chatbot-link" onclick="window.location.href='https://math-gpt.org/';">
    GPT AI
</button>


    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const imageUpload = document.getElementById('image-upload');

        // Database di risposte con immagini
        const database = {
            "che ore sono": new Date().toLocaleTimeString(),
            "ciao": "Ciao! Come posso aiutarti?",
            "come stai": "Sto bene, grazie! E tu?",
            "arrivederci": "Arrivederci! Spero di averti aiutato.",
            "gatto": "Ecco un'immagine di un gatto!",
            "cane": "Ecco un'immagine di un cane!",
            "auto": "Ecco un'immagine di un'auto!",
            "albero": "Ecco un'immagine di un'albero!",
            "default": "Mi dispiace, non ho una risposta specifica per questa domanda. Posso aiutarti con qualcos'altro?"
        };

        // Database di immagini
        const imageDatabase = {
            "gatto": "https://img.freepik.com/psd-gratis/bello-ritratto-del-gatto-isolato_23-2150186184.jpg",
            "cane": "https://img.freepik.com/vettori-gratuito/carattere-sveglio-del-fumetto-del-cane-in-piedi_1308-133833.jpg",
            "auto": "https://media-assets.wired.it/photos/615c4bfadda121baaf430e11/master/w_1600%2Cc_limit/1411469004_ferrari-458.jpg",
            "albero": "https://bomboniereliving.it/wp-content/uploads/2024/01/albero-della-vita-disegno-800x800.jpg"
        };

        // Funzione per aggiungere un messaggio alla chat
        function addMessage(message, isUser = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isUser ? 'user-message' : 'bot-message');
            messageElement.textContent = message;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Funzione per aggiungere un'immagine alla chat
        function addImage(imageUrl) {
            const imageElement = document.createElement('img');
            imageElement.src = imageUrl;
            imageElement.classList.add('uploaded-image');
            imageElement.style.maxWidth = '200px'; // Ridimensiona l'immagine per occupare meno spazio
            imageElement.style.maxHeight = '200px';
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'bot-message');
            messageElement.appendChild(imageElement);
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Funzione per calcolare espressioni matematiche
        function solveMathOperation(input) {
            try {
                const result = eval(input);
                return `Il risultato di ${input} è ${result}.`;
            } catch (error) {
                return "Mi dispiace, non riesco a calcolare questa operazione.";
            }
        }

        // Funzione per ottenere la risposta del bot
        async function getBotResponse(message) {
            const lowercaseMessage = message.toLowerCase();

            // Verifichiamo se l'input è un'operazione matematica
            if (/^[0-9+\-*/().\s]+$/.test(lowercaseMessage)) {
                return solveMathOperation(lowercaseMessage);
            }

            // Se l'input è nel database
            if (database[lowercaseMessage]) {
                return database[lowercaseMessage];
            }

            // Chiamata all'API di OpenAI per ottenere una risposta più avanzata
            try {
                const response = await fetch('https://api.openai.com/v1/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer `
                    },
                    body: JSON.stringify({
                        model: 'text-davinci-003',
                        prompt: message,
                        max_tokens: 150
                    })
                });
                const data = await response.json();
                return data.choices[0].text.trim();
            } catch (error) {
                console.error('Errore durante la chiamata all\'API di OpenAI:', error);
                return "Mi dispiace, al momento non posso rispondere alla tua domanda.";
            }
        }

        // Funzione per simulare il "pensiero" del bot con un ritardo
        function simulateBotThinking(userMessage) {
            setTimeout(async () => {
                const botResponse = await getBotResponse(userMessage);
                addMessage(botResponse); // Aggiungi la risposta del bot alla chat

                // Verifica se ci sono immagini associate al messaggio
                const lowercaseMessage = userMessage.toLowerCase();
                if (imageDatabase[lowercaseMessage]) {
                    addImage(imageDatabase[lowercaseMessage]); // Aggiungi l'immagine alla chat
                }
            }, 1000); // Ritardo di 2 secondi per simulare il pensiero
        }

        // Funzione per l'OCR (estrarre testo dall'immagine)
        function recognizeTextFromImage(imageSrc) {
            Tesseract.recognize(
                imageSrc,
                'eng',
                {
                    logger: (m) => console.log(m) // Log dello stato dell'OCR
                }
            ).then(({ data: { text } }) => {
                console.log(text);
                // Analizza il testo estratto per trovare le opzioni di risposta
                const lines = text.split('\n');
                let answers = {};
                let correctAnswer = null;

                // Estrapola le opzioni e il testo associato
                lines.forEach(line => {
                    let match = line.match(/^([A-E])\s*[:.)-]?\s*(.*)/i);
                    if (match) {
                        const option = match[1].toUpperCase();
                        const response = match[2].trim();
                        answers[option] = response;
                    }
                });

                // Logica per determinare la risposta corretta
                if (Object.keys(answers).length > 0) {
                    correctAnswer = determineCorrectAnswer(answers, text);
                }

                if (correctAnswer) {
                    addMessage("La risposta corretta è: " + correctAnswer);
                } else {
                    // Se non si riesce a determinare una risposta corretta, seleziona una risposta casuale tra A e E
                    const randomAnswer = ['A', 'B', 'C', 'D', 'E'][Math.floor(Math.random() * 5)];
                   // addMessage("Non sono riuscito a determinare la risposta corretta. Risposta selezionata casualmente: " + randomAnswer);
                }

            }).catch(error => {
                console.error(error);
                addMessage("Errore nel riconoscimento del testo.");
            });
        }

        // Funzione per determinare la risposta corretta basata sulla logica, statistica e comprensione del testo
        function determineCorrectAnswer(answers, text) {
            // Logica specifica per determinare la risposta corretta basata sull'analisi del contenuto
            // Identificazione del contesto: logica, statistica, comprensione del testo
            if (text.toLowerCase().includes("soprannominato \"casper\"")) {
                // Caso di comprensione del testo specifico
                for (const [key, value] of Object.entries(answers)) {
                    if (value.includes("soprannominato \"Casper\"")) {
                        return key;
                    }
                }
            } else if (text.toLowerCase().includes("percentuale") || text.toLowerCase().includes("probabilità")) {
                // Caso statistico: cerca parole chiave come "percentuale" o "probabilità"
                for (const [key, value] of Object.entries(answers)) {
                    if (value.includes("%") || value.toLowerCase().includes("probabilità")) {
                        return key;
                    }
                }
            } else if (text.toLowerCase().includes("logica") || text.toLowerCase().includes("se allora")) {
                // Caso logico: cerca parole chiave come "logica" o "se allora"
                for (const [key, value] of Object.entries(answers)) {
                    if (value.toLowerCase().includes("se") && value.toLowerCase().includes("allora")) {
                        return key;
                    }
                }
            }

            // Se non viene trovata una risposta specifica, restituisce la prima opzione come esempio
            return Object.keys(answers)[0];
        }

        // Funzione per analizzare l'immagine e riconoscere le forme con OpenCV
        function analyzeImage(imgElement) {
            // Converti l'immagine in una matrice OpenCV
            const src = cv.imread(imgElement);
            const dst = new cv.Mat();
            const contours = new cv.MatVector();
            const hierarchy = new cv.Mat();
            
            // Converti l'immagine in scala di grigi
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY, 0);
            
            // Applica una soglia per binarizzare l'immagine
            cv.threshold(dst, dst, 127, 255, cv.THRESH_BINARY);

            // Trova i contorni
            cv.findContours(dst, contours, hierarchy, cv.RETR_CCOMP, cv.CHAIN_APPROX_SIMPLE);

            let blackSquares = 0;

            for (let i = 0; i < contours.size(); i++) {
                const cnt = contours.get(i);
                const area = cv.contourArea(cnt);
                if (area > 50) { // Filtro per ignorare i rumori
                    const approx = new cv.Mat();
                    cv.approxPolyDP(cnt, approx, 0.02 * cv.arcLength(cnt, true), true);
                    if (approx.rows === 4) { // Considera i contorni con 4 lati come quadrati
                        blackSquares++;
                    }
                    approx.delete();
                }
                cnt.delete();
            }

            // Pulisci la memoria
            src.delete();
            dst.delete();
            contours.delete();
            hierarchy.delete();

            // Determina una risposta basata sul numero di quadrati rilevati
            const possibleAnswers = ['A', 'B', 'C', 'D', 'E'];
            const selectedAnswer = possibleAnswers[blackSquares % possibleAnswers.length];
            addMessage("La risposta basata sull'analisi dell'immagine è: " + selectedAnswer);
        }

        // Evento per gestire il caricamento delle immagini da parte dell'utente
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '200px'; // Ridimensiona l'immagine per occupare meno spazio
                    img.style.maxHeight = '200px';
                    img.onload = () => {
                        chatContainer.appendChild(img);
                        // OCR per estrarre il testo
                        recognizeTextFromImage(e.target.result);
                        // Analizza le forme
                        analyzeImage(img);  
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        // Evento al clic del bottone di invio
        sendButton.addEventListener('click', () => {
            const message = userInput.value.trim();
            if (message) {
                addMessage(message, true);  // Aggiungi il messaggio dell'utente alla chat
                userInput.value = '';  // Resetta l'input
                simulateBotThinking(message);  // Simula il "pensiero" e rispondi
            }
        });

        // Evento alla pressione del tasto "Enter"
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
    </script>
</body>
</html>
